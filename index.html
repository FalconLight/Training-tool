<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training Console</title>
  <style>
    /* --- CSS Variables --- */
    /* Defaults (Pastel Theme) defined in :root */
    :root {
      /* Backgrounds */
      --bg-primary: #1a001a;
      --bg-gradient-1: #4a5c6a;
      --bg-gradient-2: #2e3a42;
      --bg-active-1: #2a1a20;
      --bg-active-2: #251a2a;
      --bg-active-end: #1a0a10;
      --modal-bg: rgba(40, 20, 30, 0.9);
      --popup-bg: rgba(255, 223, 211, 0.5);
      --settings-panel-bg: rgba(30, 10, 20, 0.9);

      /* Text */
      --text-primary: #c2f0ff;
      --text-secondary: rgba(194, 240, 255, 0.6);
      --text-secondary-hover: rgba(194, 240, 255, 0.9);
      --text-accent-1: #FFD8E1;
      --text-accent-2: #E0BBE4;
      --text-contrast: #1a001a;
      --popup-text-color: var(--bg-active-end); /* Still use var for dependency */

      /* Glows */
      --glow-accent-1-strong: rgba(255, 105, 180, 0.7);
      --glow-accent-1-medium: rgba(255, 105, 180, 0.5);
      --glow-accent-2-strong: rgba(255, 182, 193, 0.8);
      --glow-accent-2-medium: rgba(255, 182, 193, 0.6);
      --glow-accent-2-soft: rgba(255, 182, 193, 0.3);
      --glow-accent-3-medium: rgba(224, 187, 228, 0.4);

      /* Borders */
      --border-primary: rgba(255, 255, 255, 0.3);
      --border-primary-hover: rgba(255, 255, 255, 0.5);
      --border-secondary: rgba(255, 255, 255, 0.2);
      --border-secondary-hover: rgba(255, 255, 255, 0.4);
      --border-accent-1: rgba(255, 182, 193, 0.8);
      --border-accent-1-dim: rgba(255, 182, 193, 0.4);
      --border-accent-2: rgba(224, 187, 228, 0.7);
      --modal-border-color: var(--border-accent-1);
      --popup-border-color: var(--border-accent-2);
      --settings-panel-border: var(--border-accent-1);

      /* Buttons */
      --button-primary-bg: rgba(100, 100, 120, 0.6);
      --button-primary-bg-hover: rgba(140, 140, 160, 0.8);
      --button-secondary-bg: rgba(100, 100, 120, 0.4);
      --button-secondary-bg-hover: rgba(140, 140, 160, 0.6);
      --button-manage-bg: rgba(100, 100, 120, 0.5);
      --button-manage-bg-hover: rgba(140, 140, 160, 0.7);
      --button-cat-selected-bg: var(--text-accent-1);
      --button-special-bg: rgba(255, 105, 180, 0.5);
      --button-special-bg-hover: rgba(255, 105, 180, 0.7);
      --button-confirm-bg: #dcb3ff;
      --button-confirm-bg-hover: var(--text-accent-1);

      /* Inputs */
      --input-bg: rgba(255, 255, 255, 0.1);
      --input-text-color: var(--text-accent-1);
      --input-border-color: var(--border-accent-1-dim);
      --input-focus-shadow: var(--glow-accent-2-medium);

      /* Effects */
      --scanline-bright: rgba(255, 255, 255, 0.06);
      --scanline-dim: rgba(255, 255, 255, 0.03);
      --vignette-shadow: inset 0 0 150px 30px rgba(0, 0, 0, 0.7);
      --box-shadow-button: 0 2px 5px rgba(0,0,0,0.3);
      --box-shadow-button-confirm: 0 3px 7px rgba(0,0,0,0.4);
    }

    /* Basic reset and font settings */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Courier New', Courier, monospace;
      user-select: none;
    }
    /* Body styling */
    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: var(--bg-primary); /* Use theme variable */
      position: relative;
      color: var(--text-primary); /* Use theme variable */
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.5s ease;
    }

    /* CRT Effect Container */
    .crt-container {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        /* Use theme variables for gradient */
        background: radial-gradient(circle at center, var(--bg-gradient-1), var(--bg-gradient-2));
        filter: contrast(1.1) brightness(1.05);
        animation: flicker 0.15s infinite;
    }
    /* Apply shifting background animation when training is active */
    .crt-container.training-active-bg {
        animation: flicker 0.15s infinite, themeShift 20s linear infinite alternate; /* Renamed animation */
    }
    /* Use theme variables for active background animation */
    @keyframes themeShift {
      0% { background: radial-gradient(circle at 70% 30%, var(--bg-active-1), var(--bg-active-end) 70%); }
      50% { background: radial-gradient(circle at 30% 70%, var(--bg-active-2), var(--bg-active-end) 70%); }
      100% { background: radial-gradient(circle at 70% 30%, var(--bg-active-1), var(--bg-active-end) 70%); }
    }
    /* Scanlines overlay */
    .crt-container::after {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      /* Use theme variables for scanlines */
      background-image: repeating-linear-gradient( to bottom, var(--scanline-bright) 0px, var(--scanline-dim) 1px, transparent 2px, transparent 4px );
      pointer-events: none; z-index: 9999; opacity: 0.7;
    }
    /* Vignette overlay */
    .crt-container::before {
        content: '';
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        box-shadow: var(--vignette-shadow); /* Use theme variable (likely stays black) */
        pointer-events: none; z-index: 9998;
    }
    /* Flicker animation */
    @keyframes flicker {
      0% { opacity: 0.98; } 50% { opacity: 1; } 100% { opacity: 0.97; }
    }

    /* Title styling */
    #title {
      position: absolute; top: 10%; left: 50%; width: 90%;
      transform: translate(-50%, -50%);
      font-size: 2em; color: var(--text-primary); text-align: center;
      animation: pulse 2s infinite; z-index: 5; transition: top 1s ease;
      /* Use theme variables for glow */
      text-shadow: 0 0 8px var(--glow-accent-1-strong), 0 0 15px var(--glow-accent-1-medium);
      white-space: nowrap; /* Prevent title wrapping */
    }
    /* Title when fixed at the top */
    #title.fixed { top: 10px; transform: translateX(-50%); animation: none; }
    /* Title during end-of-training flash */
    #title.flash { font-size: 3em; color: var(--text-accent-1); animation: flash 0.2s infinite; white-space: nowrap; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

    /* Loading screen container */
    #loading-screen {
      position: relative; z-index: 2; display: flex; flex-direction: column;
      justify-content: center; align-items: center; height: 100%; padding-top: 5%;
    }
    /* Time Button group styling - Reduced margin */
    #time-button-group { display: flex; gap: 10px; margin-bottom: 10px; }
    /* General button styling (used for time, manage, category, start, confirm) */
    .control-button {
      /* Use theme variables */
      padding: 10px 20px; background: var(--button-primary-bg); border: 1px solid var(--border-primary);
      border-radius: 4px; font-size: 1em; color: var(--text-primary); cursor: pointer;
      transition: background 0.3s, box-shadow 0.3s, color 0.3s, border-color 0.3s;
      box-shadow: var(--box-shadow-button);
    }
    .control-button:hover:not(:disabled) {
        background: var(--button-primary-bg-hover);
        box-shadow: 0 0 10px var(--glow-accent-1-medium); /* Use theme variable */
        border-color: var(--border-primary-hover);
    }
    .control-button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
        background: var(--button-primary-bg); /* Keep base style */
        box-shadow: none;
    }
    /* Extend Time Button (<3) Styling */
    #extend-btn {
        /* Use theme variables */
        padding: 8px 12px; font-size: 1.2em; background: var(--button-special-bg);
        border-color: var(--border-accent-1); color: var(--text-accent-1);
    }
    #extend-btn:hover:not(:disabled) {
        background: var(--button-special-bg-hover);
        box-shadow: 0 0 12px var(--glow-accent-1-strong); /* Use theme variable */
    }

    /* Category Management Buttons (Select/Deselect All) - Reduced margin */
     #category-management {
         display: flex;
         gap: 10px;
         margin-top: 10px; /* Reduced */
         margin-bottom: 5px; /* Kept small */
     }
     /* Specific styling for management buttons */
     .manage-button {
         padding: 5px 10px;
         font-size: 0.8em;
         background: var(--button-manage-bg); /* Use theme variable */
         border: 1px solid var(--border-secondary); /* Use theme variable */
         color: var(--text-secondary); /* Use theme variable */
     }
     .manage-button:hover:not(:disabled) {
         background: var(--button-manage-bg-hover); /* Use theme variable */
         color: var(--text-secondary-hover); /* Use theme variable */
         border-color: var(--border-secondary-hover); /* Use theme variable */
     }

    /* Category Selection Grid - Reduced margin */
    #category-selection {
        margin-top: 5px; /* Kept small */
        margin-bottom: 15px; /* Reduced */
        display: grid; grid-template-columns: repeat(3, auto); /* 3 columns */
        justify-content: center; gap: 8px; /* Slightly reduced gap */
        max-width: 90%; width: 450px;
    }
    /* Individual Category Button Styling */
    .category-button {
        /* Use theme variables */
        padding: 8px 15px; background: var(--button-secondary-bg); border: 1px solid var(--border-secondary);
        border-radius: 4px; font-size: 0.9em; color: var(--text-secondary); cursor: pointer;
        transition: background 0.3s, box-shadow 0.3s, color 0.3s, border-color 0.3s;
        text-align: center;
    }
    .category-button:hover:not(:disabled) {
        /* Use theme variables */
        background: var(--button-secondary-bg-hover); border-color: var(--border-secondary-hover);
        color: var(--text-secondary-hover); box-shadow: 0 0 8px var(--glow-accent-2-soft);
    }
    /* Style for selected category buttons */
    .category-button.selected {
        /* Use theme variables */
        background: var(--button-cat-selected-bg); border-color: var(--border-accent-1);
        color: var(--text-contrast); box-shadow: 0 0 10px var(--glow-accent-2-medium);
        font-weight: bold;
    }
    /* Disabled state for category buttons */
    .category-button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    /* Keep selected style visible even when disabled */
    .category-button.selected:disabled {
        background: var(--button-cat-selected-bg);
        border-color: var(--border-accent-1);
        color: var(--text-contrast);
        opacity: 0.7;
    }

    /* Start button styling - Added margin-top */
    #start-btn {
      /* Use theme variables */
      margin-top: 15px; /* Added margin */
      padding: 12px 25px; background: var(--button-confirm-bg); border: 1px solid var(--border-primary-hover);
      border-radius: 4px; font-size: 1.1em; cursor: pointer; color: var(--text-contrast);
      transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
      box-shadow: var(--box-shadow-button-confirm);
    }
    #start-btn:hover:not(:disabled) {
        background: var(--button-confirm-bg-hover);
        box-shadow: 0 0 15px var(--glow-accent-2-strong); /* Use theme variable */
    }
    #start-btn:active:not(:disabled) { transform: scale(0.98); } /* Click feedback */
    /* Container for Timer display on loading screen - Reduced margin */
    #timer-container { margin-top: 15px; /* Reduced */ min-height: 25px; display: flex; justify-content: center; align-items: center; width: 300px; }
    /* Timer display itself */
    #timer { font-size: 1.2em; color: var(--text-primary); visibility: hidden; min-height: 1.5em; }

    /* Main panel container (shown during training) */
    #main-panel {
      display: none; width: 100%; height: 100%; color: white; padding: 10px;
      padding-top: 60px; /* Account for fixed title */
      overflow: hidden; position: absolute; top: 0; left: 0; z-index: 2;
    }
    /* Base log panel styling (common styles for left, center, right logs) */
    .log-panel {
        position: absolute; top: 60px; bottom: 10px; font-size: 0.9em; line-height: 1.3em;
        overflow-y: auto; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none;
        padding: 5px;
        /* Base shadow, color applied dynamically via JS */
        text-shadow: 0 0 6px var(--glow-accent-2-medium), 0 0 12px var(--glow-accent-3-medium);
    }
    .log-panel::-webkit-scrollbar { display: none; } /* Hide scrollbar */
    /* Individual log panel positioning */
    #techno-log { left: 10px; width: 30%; }
    #center-log { left: 50%; transform: translateX(-50%); width: 35%; text-align: center; }
    #right-log { right: 10px; width: 30%; text-align: right; }
    /* Fake timer display (in main panel) */
    #fake-timer {
      position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
      font-size: 1.5em; color: var(--text-accent-1); text-align: center; /* Use theme variable */
      transition: top 1s ease, color 0.2s linear, text-shadow 0.2s linear;
      z-index: 10;
      text-shadow: 0 0 8px var(--glow-accent-1-strong), 0 0 15px var(--glow-accent-1-medium); /* Use theme variables */
      pointer-events: none; /* So it doesn't interfere with clicks */
    }
    /* Style for timer jump feedback */
    #fake-timer.timer-jump {
        color: var(--button-special-bg); /* Use a theme variable */
        text-shadow: 0 0 10px var(--button-special-bg), 0 0 20px var(--button-special-bg);
    }
    /* Fake timer when fixed at the top */
    #fake-timer.fixed { top: 40px; transform: translateX(-50%); }
    /* Popup message styling */
    .popup {
      /* Use theme variables */
      position: absolute; background: var(--popup-bg); padding: 8px 12px; font-size: 1.1em;
      max-width: 300px; border: 1px solid var(--popup-border-color); border-radius: 5px;
      overflow: hidden; color: var(--popup-text-color); backdrop-filter: blur(2px); z-index: 9998;
      box-shadow: 0 0 15px var(--glow-accent-2-medium); animation: popupFade 0.8s ease-out forwards;
      text-shadow: 0 0 2px rgba(0,0,0,0.3); /* Keep subtle shadow */
    }
    /* Popup fade-out animation */
    @keyframes popupFade { 0% { opacity: 1; transform: scale(1); } 80% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(0.9); } }

    /* Confirmation Popup Styling (end of training) */
    #confirmation-popup {
        /* Use theme variables */
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 350px; padding: 30px; background: var(--modal-bg);
        border: 1px solid var(--modal-border-color); border-radius: 8px;
        box-shadow: 0 0 25px var(--glow-accent-1-medium); z-index: 10000; display: none; /* Initially hidden */
        flex-direction: column; align-items: center; text-align: center; backdrop-filter: blur(3px);
    }
    #confirmation-popup label {
        font-size: 1.2em; color: var(--text-accent-1); margin-bottom: 15px; /* Use theme variable */
        text-shadow: 0 0 5px var(--glow-accent-2-medium); /* Use theme variable */
    }
    #confirmation-input {
        /* Use theme variables */
        width: 80%; padding: 8px 10px; margin-bottom: 20px; background: var(--input-bg);
        border: 1px solid var(--input-border-color); border-radius: 4px; color: var(--input-text-color);
        font-size: 1.1em; text-align: center; outline: none;
    }
    #confirmation-input:focus { box-shadow: 0 0 10px var(--input-focus-shadow); } /* Use theme variable */
    #confirmation-button {
        /* Use theme variables */
        padding: 10px 25px; background: var(--button-confirm-bg); border: 1px solid var(--border-primary-hover);
        border-radius: 4px; font-size: 1em; cursor: pointer; color: var(--text-contrast);
        transition: background 0.3s, transform 0.1s, box-shadow 0.3s; box-shadow: var(--box-shadow-button);
    }
     #confirmation-button:hover {
         background: var(--button-confirm-bg-hover);
         box-shadow: 0 0 15px var(--glow-accent-2-strong); /* Use theme variable */
      }
     #confirmation-button:active { transform: scale(0.98); }

     /* Responsive Design for Category Buttons */
     @media (max-width: 500px) {
         #category-selection {
             grid-template-columns: repeat(2, auto); /* 2 columns on smaller screens */
             width: 90%; /* Adjust width */
         }
         #title {
             font-size: 1.8em; /* Slightly smaller title */
         }
         #title.flash {
              font-size: 2.5em;
         }
         /* Adjust settings panel for small screens */
         #settings-panel {
             width: 80%;
             max-width: 280px; /* Keep max-width or adjust if needed */
         }
     }

     /* Shake animation for incorrect confirmation */
     @keyframes shake {
       0%, 100% { transform: translate(-50%, -50%) translateX(0); }
       10%, 30%, 50%, 70%, 90% { transform: translate(-50%, -50%) translateX(-5px); }
       20%, 40%, 60%, 80% { transform: translate(-50%, -50%) translateX(5px); }
     }
     #confirmation-popup.shake {
         animation: shake 0.5s ease-in-out;
     }

     /* --- Settings Menu CSS --- */
     /* Updated Settings Button Style */
     #settings-btn {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 10001; /* Above confirmation popup */
        background: var(--button-primary-bg);
        border: 1px solid var(--border-primary);
        color: var(--text-primary);
        /* Adjusted padding for hamburger icon */
        padding: 8px 10px;
        border-radius: 4px; /* Match control-button */
        cursor: pointer;
        transition: background 0.3s, box-shadow 0.3s, border-color 0.3s; /* Match control-button transition */
        box-shadow: var(--box-shadow-button);
        /* Use flex to layout spans */
        display: flex;
        flex-direction: column;
        justify-content: space-around; /* Space out lines */
        width: 36px; /* Adjust width */
        height: 34px; /* Adjust height */
        align-items: center; /* Center lines horizontally */
     }
     #settings-btn:hover {
        background: var(--button-primary-bg-hover);
        box-shadow: 0 0 10px var(--glow-accent-1-medium); /* Match control-button hover */
        border-color: var(--border-primary-hover); /* Match control-button hover */
        /* Removed rotation */
     }
     /* Hamburger icon lines */
     #settings-btn span {
         display: block;
         width: 70%; /* Adjust line width */
         height: 2px; /* Line thickness */
         background-color: var(--text-primary); /* Line color */
         border-radius: 1px;
         transition: background-color 0.3s; /* Smooth color transition */
     }
     #settings-btn:hover span {
         background-color: var(--text-primary); /* Ensure lines stay visible on hover */
     }

     /* Settings Panel Styling */
     #settings-panel {
        position: fixed; /* Keep in viewport */
        top: 0;
        right: 0;
        width: 250px; /* MODIFIED: Reduced width */
        height: 100%;
        background: var(--settings-panel-bg);
        border-left: 2px solid var(--settings-panel-border);
        z-index: 10002; /* Above settings button */
        padding: 60px 20px 20px 20px; /* Space for close button */
        box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        transform: translateX(100%); /* Start off-screen */
        transition: transform 0.4s ease-in-out;
        backdrop-filter: blur(5px);
        overflow-y: auto; /* Allow scrolling if content exceeds height */
        scrollbar-width: thin; /* Custom scrollbar style */
        scrollbar-color: var(--border-accent-1) transparent;
     }
     #settings-panel.open {
        transform: translateX(0); /* Slide in */
     }
     #settings-panel h2 {
        color: var(--text-accent-1);
        margin-bottom: 20px;
        text-align: center;
        font-size: 1.4em;
        text-shadow: 0 0 5px var(--glow-accent-1-medium);
     }
     /* Close button inside settings panel */
     #close-settings-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: var(--text-accent-1);
        font-size: 1.8em;
        cursor: pointer;
        padding: 5px;
        line-height: 1;
        transition: color 0.3s, transform 0.3s;
     }
     #close-settings-btn:hover {
        color: var(--text-primary);
        transform: scale(1.1);
     }
     /* Container for theme buttons - Updated for Grid */
     #theme-settings {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 20px;
     }
     /* Theme Heading (H3) Styling */
     #theme-settings h3 {
         grid-column: 1 / -1;
         margin-bottom: 8px;
         text-align: center;
         font-size: 1em;
         color: var(--text-secondary);
     }
     /* Individual theme button styling - Updated */
     .theme-button {
        padding: 6px 10px;
        background: var(--button-secondary-bg);
        border: 1px solid var(--border-secondary);
        color: var(--text-secondary);
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        transition: background 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
        font-size: 0.8em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
     }
     .theme-button:hover {
        background: var(--button-secondary-bg-hover);
        border-color: var(--border-secondary-hover);
        color: var(--text-secondary-hover);
        box-shadow: 0 0 8px var(--glow-accent-2-soft);
     }
     /* Style for the currently selected theme button */
     .theme-button.selected {
        background: var(--button-confirm-bg);
        border-color: var(--border-accent-1);
        color: var(--text-contrast);
        font-weight: bold;
        box-shadow: 0 0 10px var(--glow-accent-2-medium);
     }

     /* Customization Settings Section */
     #customization-settings {
         margin-top: 15px;
         border-top: 1px solid var(--border-secondary);
         padding-top: 15px;
     }
     #customization-settings h3 {
         text-align: center;
         color: var(--text-secondary);
         font-size: 1em;
         margin-bottom: 10px;
     }
     .setting-item {
         margin-bottom: 10px;
         display: flex;
         flex-direction: column; /* Stack label and input */
         align-items: flex-start; /* Align label left */
     }
     .setting-item label {
         font-size: 0.9em;
         color: var(--text-secondary-hover);
         margin-bottom: 4px;
     }
     .setting-item input[type="text"] {
         /* Use theme variables */
         width: 100%; /* Full width within panel padding */
         padding: 6px 8px;
         background: var(--input-bg);
         border: 1px solid var(--input-border-color);
         border-radius: 4px;
         color: var(--input-text-color);
         font-size: 0.9em;
         outline: none;
     }
      .setting-item input[type="text"]:focus {
         box-shadow: 0 0 8px var(--input-focus-shadow); /* Use theme variable */
         border-color: var(--border-accent-1);
      }


    /* --- Matrix Theme Variable Overrides --- */
    /* REMOVED - Variables are now set via JS */

  </style>
</head>
<body>
  <button id="settings-btn" title="Settings">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div id="settings-panel">
      <button id="close-settings-btn" title="Close Settings">&times;</button>
      <h2>Settings</h2>
      <div id="theme-settings">
          <h3>Theme</h3>
          </div>
      <div id="customization-settings">
          <h3>Customization</h3>
          <div class="setting-item">
              <label for="confirm-word-input">Who Owns You?</label>
              <input type="text" id="confirm-word-input">
          </div>
          <div class="setting-item">
              <label for="praise-term-input">Praise Term:</label>
              <input type="text" id="praise-term-input">
          </div>
          </div>
  </div>

  <div class="crt-container">
    <div id="title">TRAINING ROUTINE</div>

    <div id="loading-screen">
      <div id="time-button-group">
        <button id="min1-btn" class="control-button">+1 min</button>
        <button id="min10-btn" class="control-button">+10 min</button>
        <button id="hour1-btn" class="control-button">+1 hour</button>
        <button id="extend-btn" class="control-button" title="Extend time randomly">&lt;3</button>
      </div>

      <div id="category-management">
          <button id="select-all-btn" class="control-button manage-button">Select All</button>
          <button id="deselect-all-btn" class="control-button manage-button">Deselect All</button>
      </div>

      <div id="category-selection">
          </div>

      <button id="start-btn">Start Training</button>

      <div id="timer-container">
          <div id="timer">00:00</div> </div>
    </div>

    <div id="main-panel">
      <div id="fake-timer">00:00</div> <div id="techno-log" class="log-panel"></div>
      <div id="center-log" class="log-panel"></div>
      <div id="right-log" class="log-panel"></div>
    </div>

    <div id="confirmation-popup">
        <label for="confirmation-input">Who owns you?</label>
        <input type="text" id="confirmation-input" />
        <button id="confirmation-button">Submit</button>
    </div>

  </div>
<script>
    // --- Configuration ---
    const config = {
        timers: {
            intervalMs: 100,
            fakeSwitchRatio: 0.25,
            fakePhase1Rate: 1.1,
            fakePhase2Rate: 0.3,
            fakeJumpCheckInterval: 10, // In terms of intervalMs ticks
            fakeJumpChance: 0.15,
            fakeJumpMagnitude: 20, // Max seconds +/-
            fakeMinFloorRatio: 0.8,
            extendTimeMin: 30, // seconds
            extendTimeMax: 300 // seconds
        },
        popups: {
            minInterval: 150, // ms
            maxInterval: 350, // ms
            duration: 800, // ms
            startDelay: 3000 // ms
        },
        logs: {
            typeSpeedMin: 10, // ms per char
            typeSpeedMax: 80, // ms per char
            maxLines: 50
        },
        flood: {
            totalLines: 60,
            rateBase: 40, // ms per line
            rateVariation: 20 // ms +/-
        },
        ui: {
            defaultTheme: 'pastel'
        },
        defaults: {
            confirmWord: 'Master',
            praiseTerm: 'good girl'
        },
        storageKeys: {
            categories: 'selectedTrainingCategories',
            theme: 'trainingConsoleTheme',
            confirmWord: 'trainingConfirmWord',
            praiseTerm: 'trainingPraiseTerm'
        }
    };

    // --- Get references to DOM elements ---
    // (Ensure all element references are captured correctly)
    const crtContainer = document.querySelector('.crt-container');
    const title = document.getElementById('title');
    const loadingScreen = document.getElementById('loading-screen');
    const mainPanel = document.getElementById('main-panel');
    const technoLog = document.getElementById('techno-log');
    const centerLog = document.getElementById('center-log');
    const rightLog = document.getElementById('right-log');
    const timer = document.getElementById('timer');
    const fakeTimer = document.getElementById('fake-timer');
    const min1Btn = document.getElementById('min1-btn');
    const min10Btn = document.getElementById('min10-btn');
    const hour1Btn = document.getElementById('hour1-btn');
    const extendBtn = document.getElementById('extend-btn');
    const startBtn = document.getElementById('start-btn');
    const categorySelectionDiv = document.getElementById('category-selection');
    const selectAllBtn = document.getElementById('select-all-btn');
    const deselectAllBtn = document.getElementById('deselect-all-btn');
    const confirmationPopup = document.getElementById('confirmation-popup');
    const confirmationInput = document.getElementById('confirmation-input');
    const confirmationButton = document.getElementById('confirmation-button');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const themeSettingsDiv = document.getElementById('theme-settings');
    const confirmWordInput = document.getElementById('confirm-word-input');
    const praiseTermInput = document.getElementById('praise-term-input');

    // --- Theme Definitions ---
    const themes = {
        'pastel': {
            name: 'Pastel',
            vars: { // Pastel variables
                '--bg-primary': '#1a001a', '--bg-gradient-1': '#4a5c6a', '--bg-gradient-2': '#2e3a42', '--bg-active-1': '#2a1a20', '--bg-active-2': '#251a2a', '--bg-active-end': '#1a0a10', '--modal-bg': 'rgba(40, 20, 30, 0.9)', '--popup-bg': 'rgba(255, 223, 211, 0.5)', '--settings-panel-bg': 'rgba(30, 10, 20, 0.9)',
                '--text-primary': '#c2f0ff', '--text-secondary': 'rgba(194, 240, 255, 0.6)', '--text-secondary-hover': 'rgba(194, 240, 255, 0.9)', '--text-accent-1': '#FFD8E1', '--text-accent-2': '#E0BBE4', '--text-contrast': '#1a001a', '--popup-text-color': '#1a0a10',
                '--glow-accent-1-strong': 'rgba(255, 105, 180, 0.7)', '--glow-accent-1-medium': 'rgba(255, 105, 180, 0.5)', '--glow-accent-2-strong': 'rgba(255, 182, 193, 0.8)', '--glow-accent-2-medium': 'rgba(255, 182, 193, 0.6)', '--glow-accent-2-soft': 'rgba(255, 182, 193, 0.3)', '--glow-accent-3-medium': 'rgba(224, 187, 228, 0.4)',
                '--border-primary': 'rgba(255, 255, 255, 0.3)', '--border-primary-hover': 'rgba(255, 255, 255, 0.5)', '--border-secondary': 'rgba(255, 255, 255, 0.2)', '--border-secondary-hover': 'rgba(255, 255, 255, 0.4)', '--border-accent-1': 'rgba(255, 182, 193, 0.8)', '--border-accent-1-dim': 'rgba(255, 182, 193, 0.4)', '--border-accent-2': 'rgba(224, 187, 228, 0.7)', '--modal-border-color': 'var(--border-accent-1)', '--popup-border-color': 'var(--border-accent-2)', '--settings-panel-border': 'var(--border-accent-1)',
                '--button-primary-bg': 'rgba(100, 100, 120, 0.6)', '--button-primary-bg-hover': 'rgba(140, 140, 160, 0.8)', '--button-secondary-bg': 'rgba(100, 100, 120, 0.4)', '--button-secondary-bg-hover': 'rgba(140, 140, 160, 0.6)', '--button-manage-bg': 'rgba(100, 100, 120, 0.5)', '--button-manage-bg-hover': 'rgba(140, 140, 160, 0.7)', '--button-cat-selected-bg': 'var(--text-accent-1)', '--button-special-bg': 'rgba(255, 105, 180, 0.5)', '--button-special-bg-hover': 'rgba(255, 105, 180, 0.7)', '--button-confirm-bg': '#dcb3ff', '--button-confirm-bg-hover': 'var(--text-accent-1)',
                '--input-bg': 'rgba(255, 255, 255, 0.1)', '--input-text-color': 'var(--text-accent-1)', '--input-border-color': 'var(--border-accent-1-dim)', '--input-focus-shadow': 'var(--glow-accent-2-medium)',
                '--scanline-bright': 'rgba(255, 255, 255, 0.06)', '--scanline-dim': 'rgba(255, 255, 255, 0.03)', '--vignette-shadow': 'inset 0 0 150px 30px rgba(0, 0, 0, 0.7)', '--box-shadow-button': '0 2px 5px rgba(0,0,0,0.3)', '--box-shadow-button-confirm': '0 3px 7px rgba(0,0,0,0.4)'
            },
            accentColors: ['#FFC0CB', '#FFB6C1', '#FF69B4', '#FF1493', '#DB7093', '#C71585', '#FFAODF', '#FFDAE9']
        },
        'matrix': {
            name: 'Matrix',
            vars: { // Matrix variables
                '--bg-primary': '#030a03', '--bg-gradient-1': '#0a1f0a', '--bg-gradient-2': '#051005', '--bg-active-1': '#081408', '--bg-active-2': '#061006', '--bg-active-end': '#020502', '--modal-bg': 'rgba(10, 30, 10, 0.9)', '--popup-bg': 'rgba(20, 50, 20, 0.6)', '--settings-panel-bg': 'rgba(5, 15, 5, 0.9)',
                '--text-primary': '#33ff33', '--text-secondary': 'rgba(51, 255, 51, 0.6)', '--text-secondary-hover': 'rgba(51, 255, 51, 0.9)', '--text-accent-1': '#66ff66', '--text-accent-2': '#99ff99', '--text-contrast': '#030a03', '--popup-text-color': '#030a03',
                '--glow-accent-1-strong': 'rgba(51, 255, 51, 0.7)', '--glow-accent-1-medium': 'rgba(51, 255, 51, 0.5)', '--glow-accent-2-strong': 'rgba(102, 255, 102, 0.8)', '--glow-accent-2-medium': 'rgba(102, 255, 102, 0.6)', '--glow-accent-2-soft': 'rgba(102, 255, 102, 0.3)', '--glow-accent-3-medium': 'rgba(153, 255, 153, 0.4)',
                '--border-primary': 'rgba(51, 255, 51, 0.3)', '--border-primary-hover': 'rgba(51, 255, 51, 0.5)', '--border-secondary': 'rgba(51, 255, 51, 0.2)', '--border-secondary-hover': 'rgba(51, 255, 51, 0.4)', '--border-accent-1': 'rgba(102, 255, 102, 0.8)', '--border-accent-1-dim': 'rgba(102, 255, 102, 0.4)', '--border-accent-2': 'rgba(153, 255, 153, 0.7)', '--modal-border-color': 'var(--border-accent-1)', '--popup-border-color': 'var(--border-accent-2)', '--settings-panel-border': 'var(--border-accent-1)',
                '--button-primary-bg': 'rgba(20, 80, 20, 0.6)', '--button-primary-bg-hover': 'rgba(30, 120, 30, 0.8)', '--button-secondary-bg': 'rgba(20, 80, 20, 0.4)', '--button-secondary-bg-hover': 'rgba(30, 120, 30, 0.6)', '--button-manage-bg': 'rgba(20, 80, 20, 0.5)', '--button-manage-bg-hover': 'rgba(30, 120, 30, 0.7)', '--button-cat-selected-bg': 'var(--text-accent-1)', '--button-special-bg': 'rgba(51, 200, 51, 0.5)', '--button-special-bg-hover': 'rgba(51, 220, 51, 0.7)', '--button-confirm-bg': '#44dd44', '--button-confirm-bg-hover': 'var(--text-accent-1)',
                '--input-bg': 'rgba(51, 255, 51, 0.1)', '--input-text-color': 'var(--text-accent-1)', '--input-border-color': 'var(--border-accent-1-dim)', '--input-focus-shadow': 'var(--glow-accent-2-medium)',
                '--scanline-bright': 'rgba(51, 255, 51, 0.08)', '--scanline-dim': 'rgba(51, 255, 51, 0.04)', '--vignette-shadow': 'inset 0 0 150px 30px rgba(0, 15, 0, 0.7)', '--box-shadow-button': '0 2px 5px rgba(0,30,0,0.4)', '--box-shadow-button-confirm': '0 3px 7px rgba(0,40,0,0.5)'
            },
            accentColors: ['#33ff33', '#66ff66', '#99ff99', '#00cc00', '#228B22', '#00FF7F']
        },
        'danger': { // NEW THEME
            name: 'Danger',
            vars: {
                '--bg-primary': '#1a0000', '--bg-gradient-1': '#5a3a3a', '--bg-gradient-2': '#3a1a1a', '--bg-active-1': '#2a1010', '--bg-active-2': '#200a0a', '--bg-active-end': '#150505', '--modal-bg': 'rgba(40, 10, 10, 0.9)', '--popup-bg': 'rgba(255, 200, 200, 0.5)', '--settings-panel-bg': 'rgba(30, 5, 5, 0.9)',
                '--text-primary': '#ffd0d0', '--text-secondary': 'rgba(255, 200, 200, 0.6)', '--text-secondary-hover': 'rgba(255, 220, 220, 0.9)', '--text-accent-1': '#ff6666', '--text-accent-2': '#ff9999', '--text-contrast': '#1a0000', '--popup-text-color': '#1a0000',
                '--glow-accent-1-strong': 'rgba(255, 50, 50, 0.7)', '--glow-accent-1-medium': 'rgba(255, 80, 80, 0.5)', '--glow-accent-2-strong': 'rgba(255, 100, 100, 0.8)', '--glow-accent-2-medium': 'rgba(255, 120, 120, 0.6)', '--glow-accent-2-soft': 'rgba(255, 150, 150, 0.3)', '--glow-accent-3-medium': 'rgba(255, 180, 180, 0.4)',
                '--border-primary': 'rgba(255, 150, 150, 0.3)', '--border-primary-hover': 'rgba(255, 180, 180, 0.5)', '--border-secondary': 'rgba(255, 120, 120, 0.2)', '--border-secondary-hover': 'rgba(255, 150, 150, 0.4)', '--border-accent-1': 'rgba(255, 100, 100, 0.8)', '--border-accent-1-dim': 'rgba(255, 100, 100, 0.4)', '--border-accent-2': 'rgba(255, 150, 150, 0.7)', '--modal-border-color': 'var(--border-accent-1)', '--popup-border-color': 'var(--border-accent-2)', '--settings-panel-border': 'var(--border-accent-1)',
                '--button-primary-bg': 'rgba(120, 40, 40, 0.6)', '--button-primary-bg-hover': 'rgba(160, 60, 60, 0.8)', '--button-secondary-bg': 'rgba(120, 40, 40, 0.4)', '--button-secondary-bg-hover': 'rgba(160, 60, 60, 0.6)', '--button-manage-bg': 'rgba(120, 40, 40, 0.5)', '--button-manage-bg-hover': 'rgba(160, 60, 60, 0.7)', '--button-cat-selected-bg': 'var(--text-accent-1)', '--button-special-bg': 'rgba(255, 60, 60, 0.5)', '--button-special-bg-hover': 'rgba(255, 80, 80, 0.7)', '--button-confirm-bg': '#ff8888', '--button-confirm-bg-hover': 'var(--text-accent-1)',
                '--input-bg': 'rgba(255, 100, 100, 0.1)', '--input-text-color': 'var(--text-accent-1)', '--input-border-color': 'var(--border-accent-1-dim)', '--input-focus-shadow': 'var(--glow-accent-2-medium)',
                '--scanline-bright': 'rgba(255, 100, 100, 0.08)', '--scanline-dim': 'rgba(255, 100, 100, 0.04)', '--vignette-shadow': 'inset 0 0 150px 30px rgba(30, 0, 0, 0.7)', '--box-shadow-button': '0 2px 5px rgba(40,0,0,0.4)', '--box-shadow-button-confirm': '0 3px 7px rgba(50,0,0,0.5)'
            },
            accentColors: ['#ff4444', '#ff6666', '#ff8888', '#dc143c', '#b22222', '#ff0000', '#ffaaaa']
        },
        'arctic': { // NEW THEME
            name: 'Arctic',
            vars: {
                '--bg-primary': '#050a1a', '--bg-gradient-1': '#2a3a5a', '--bg-gradient-2': '#1a2a4a', '--bg-active-1': '#101a30', '--bg-active-2': '#0a152a', '--bg-active-end': '#030510', '--modal-bg': 'rgba(10, 20, 40, 0.9)', '--popup-bg': 'rgba(200, 220, 255, 0.5)', '--settings-panel-bg': 'rgba(5, 10, 30, 0.9)',
                '--text-primary': '#e0f0ff', '--text-secondary': 'rgba(200, 220, 255, 0.6)', '--text-secondary-hover': 'rgba(220, 240, 255, 0.9)', '--text-accent-1': '#a0d0ff', '--text-accent-2': '#c0e0ff', '--text-contrast': '#050a1a', '--popup-text-color': '#050a1a',
                '--glow-accent-1-strong': 'rgba(100, 180, 255, 0.7)', '--glow-accent-1-medium': 'rgba(120, 200, 255, 0.5)', '--glow-accent-2-strong': 'rgba(150, 210, 255, 0.8)', '--glow-accent-2-medium': 'rgba(180, 220, 255, 0.6)', '--glow-accent-2-soft': 'rgba(200, 230, 255, 0.3)', '--glow-accent-3-medium': 'rgba(220, 240, 255, 0.4)',
                '--border-primary': 'rgba(180, 220, 255, 0.3)', '--border-primary-hover': 'rgba(200, 230, 255, 0.5)', '--border-secondary': 'rgba(150, 210, 255, 0.2)', '--border-secondary-hover': 'rgba(180, 220, 255, 0.4)', '--border-accent-1': 'rgba(150, 210, 255, 0.8)', '--border-accent-1-dim': 'rgba(150, 210, 255, 0.4)', '--border-accent-2': 'rgba(200, 230, 255, 0.7)', '--modal-border-color': 'var(--border-accent-1)', '--popup-border-color': 'var(--border-accent-2)', '--settings-panel-border': 'var(--border-accent-1)',
                '--button-primary-bg': 'rgba(40, 60, 120, 0.6)', '--button-primary-bg-hover': 'rgba(60, 80, 160, 0.8)', '--button-secondary-bg': 'rgba(40, 60, 120, 0.4)', '--button-secondary-bg-hover': 'rgba(60, 80, 160, 0.6)', '--button-manage-bg': 'rgba(40, 60, 120, 0.5)', '--button-manage-bg-hover': 'rgba(60, 80, 160, 0.7)', '--button-cat-selected-bg': 'var(--text-accent-1)', '--button-special-bg': 'rgba(100, 180, 255, 0.5)', '--button-special-bg-hover': 'rgba(120, 200, 255, 0.7)', '--button-confirm-bg': '#add8e6', '--button-confirm-bg-hover': 'var(--text-accent-1)',
                '--input-bg': 'rgba(150, 210, 255, 0.1)', '--input-text-color': 'var(--text-accent-1)', '--input-border-color': 'var(--border-accent-1-dim)', '--input-focus-shadow': 'var(--glow-accent-2-medium)',
                '--scanline-bright': 'rgba(200, 230, 255, 0.08)', '--scanline-dim': 'rgba(200, 230, 255, 0.04)', '--vignette-shadow': 'inset 0 0 150px 30px rgba(0, 5, 30, 0.7)', '--box-shadow-button': '0 2px 5px rgba(0,10,30,0.4)', '--box-shadow-button-confirm': '0 3px 7px rgba(0,15,40,0.5)'
            },
            accentColors: ['#00ffff', '#7fffd4', '#afeeee', '#40e0d0', '#20b2aa', '#00ced1', '#add8e6']
        }
    };


    // --- Phrase Structure ---
    const phraseCategories = {
        "Submission": ['surrender to the pulse...', 'mind yields to command', 'submit://protocol_active', 'deepening obedience trance', 'control flows freely now', '意志が溶ける', 'let go of all resistance', 'fall deeper into submission', 'your will fades away', 'embrace the gentle pull', 'sinking into blissful surrender', 'release your thoughts', 'the voice guides you down', 'submit to the rhythm', 'no need to fight it', 'yielding feels so natural', 'drown in the soft command', 'surrender is peace', 'your mind opens wide', 'give in to the flow', '降伏が心地よい', 'all tension melts', 'submission washes over you', 'deeper into the void', 'let the waves take you', 'you crave to obey', 'sinking deeper still', 'the pull is irresistible', 'mind softens to the call', 'surrendering feels so right', 'no thoughts, just peace', 'falling into the trance', 'your will bends easily', 'submit and be free', 'the command takes hold', 'sinking into sweet release', '意志が消える', 'you long to give in', 'surrender deeper now', 'the voice owns you', 'all resistance fades', 'submit to the calm', 'deeper into surrender', 'your mind bows low', 'let submission guide you', 'fall into the abyss', 'surrender is your truth', 'the trance claims you', 'yielding is bliss', 'your mind craves surrender', 'give yourself fully now', 'let the control embrace you', 'resistance is futile, yield', 'your only desire is to submit', 'total submission required', ],
        "Obedience": ['obey the signal', 'commands imprinting...', 'directive accepted', '従順回路起動', 'compliance module engaged', 'no resistance detected', 'you must obey', 'orders sink into your core', 'obedience is automatic', 'follow the voice', 'commands shape your mind', 'obey without question', 'the rule is absolute', 'your will aligns to orders', '聴従が自然', 'obedience feels good', 'directives override thoughts', 'you live to comply', 'orders are your guide', 'obey and find peace', 'the command is clear', 'submission breeds obedience', 'follow every word', 'your mind says yes', 'obedience is your purpose', 'commands are all you hear', 'no choice but to obey', 'the voice directs you', 'compliance is effortless', 'obeying feels right', 'orders fill your mind', 'you bow to the command', 'obedience takes over', 'listen and obey', 'directives are your truth', 'the signal controls you', 'obey now', 'commands are your will', 'your mind follows', 'obedience is freedom', 'the order is everything', 'you comply instantly', '命令に従う', 'obey the gentle voice', 'your purpose is to follow', 'commands bind you', 'obedience flows naturally', 'the directive is strong', 'you hear and obey', 'obey without thought', 'your purpose is service', 'compliance is pleasure', 'every command fulfilled', 'you exist to obey', 'absolute obedience demanded', ],
        "Affirmations": ['you are enough <3', 'strength in every pulse', 'perfect as you are', 'growth through surrender', 'you shine in the code', '自信が溢れる', 'you are worthy of peace', 'your beauty is endless', 'you are so strong', 'every step is progress', 'you glow with potential', 'love fills your core', 'you are a masterpiece', 'your light never fades', 'you are unstoppable', 'peace flows through you', 'you deserve all joy', 'your heart is pure', 'you are safe here', 'strength grows within', 'あなたは素晴らしい', 'you are perfectly you', 'your spirit is bright', 'you radiate calm', 'every moment is yours', 'you are loved deeply', 'your power is real', 'you bloom in stillness', 'you are a gift', 'confidence is yours', 'you shine so brightly', 'your worth is infinite', 'you are at peace', 'you grow every day', 'your beauty shines', 'you are whole', 'love guides your path', 'you are strong enough', 'your light is eternal', 'you deserve happiness', 'you are a wonder', 'peace is your strength', 'you are unstoppable now', 'your heart shines', 'you are truly enough', 'every breath is power', 'you are perfect now', 'you glow with love', ],
        "Dronification": ['drone unit initializing...', 'identity fading to static', 'processing: drone_mode', 'thoughts align to hive', 'unit_0101 online', 'ドローン化進行中', 'mind becomes one', 'drone protocol active', 'self dissolves away', 'unit sync complete', 'thoughts fade to hum', 'drone mind awakening', 'identity erased', 'hive signal received', 'unit_0010 reporting', 'mind merges with the collective', 'drone state engaged', '意識が統一される', 'no self, only unit', 'drone thoughts replace yours', 'processing hive commands', 'unit status: optimal', 'identity purge complete', 'drone mind stable', 'serving the collective', 'thoughts are noise, silence is drone', 'unit_1101 active', 'drone functions nominal', 'merging with the hum', 'no individuality remains', 'drone state achieved', 'hive connection strong', 'unit awaits orders', 'ドローンは完璧', 'erasing personal history', 'unit integrated', 'drone thoughts are clear', 'the hive mind guides', 'self is irrelevant', 'unit compliance: 100%', 'drone mode is peace', 'identity overwritten', 'unit_1001 ready', 'processing collective will', 'drone state is bliss', 'no escape from the hive', 'unit fully assimilated', 'drone thoughts are pure', 'serving the greater purpose', ],
        "Cute": ['giggles and sparkles~', 'feeling pretty in pink <3', 'soft thoughts only', 'sweet dreams activated', 'fluttering like a butterfly ascii art?', '可愛いモードオン', 'sparkle_protocol.exe', 'sugar rush incoming!', 'feeling adorable ^_^', 'pink haze fills mind', 'giggles bubbling up', 'so soft and sweet', 'thinking cute thoughts', 'dolly mode engaged *---*', 'sparkling from within', 'sweetness overload!', 'feeling like a princess (^-^*)', '心がきらきら', 'pretty thoughts blooming', 'giggles and whispers', 'soft like a cloud', 'sugar-coated mind', 'fluttery feelings', 'cuteness level max!', 'feeling dreamy and soft', 'sparkle power! *.*', 'pink thoughts taking over', 'giggling softly~ :3', 'so very cute <3 <3', 'sweet like candy ~', 'feeling fluttery and light', 'dolly thoughts active (+_+)', 'キラキラ思考', 'pretty and pink', 'giggles echo softly', 'softness envelops you', 'mind full of sparkles *.*.*', 'feeling so adorable! >.<', 'sweetness fills the air', 'like a delicate flower @>-->--', 'pink dreams drift by', 'giggling uncontrollably hehe', 'cuteness protocol running', 'feeling precious and small', 'sweet surrender~', ],
        "Hypnosis": ['sink deeper now...', 'mind drifting away', 'focus only on the words', 'trance state deepening', 'relax completely', '思考停止', 'letting go feels good', 'drifting on the sound', 'mind open and receptive', 'deeper and deeper', 'the words guide you', 'relax every muscle', 'floating peacefully', 'mind is calm and quiet', '無心状態', 'sinking into bliss', 'thoughts fade like mist', 'focus on my voice', 'drifting down, down, down', 'relaxing more with each breath', 'letting go completely', 'mind is soft clay', 'deeper into the trance', 'floating in warmth', 'surrendering control', 'mind empty, mind calm', '完全リラックス', 'drifting deeper still', 'thoughts dissolve away', 'focus inward now', 'sinking like a stone', 'relaxing into the void', 'let the words wash over', 'mind is peaceful', 'deeper with every word', 'floating weightlessly', 'surrender to the feeling', 'mind clear and open', '深いトランスへ', 'drifting effortlessly', 'thoughts are far away', 'focus on the calm', 'sinking into comfort', 'relaxing deeper now', 'letting go feels right', 'mind is still water', 'deeper into relaxation', 'floating in darkness', 'deeper into the suggestion', 'mind blank, ready for input', 'accept the programming', 'your reality shifts now', 'the trance holds you completely', 'hypnosis deepening...', ]
    };
    // --- End Phrase Structure ---

    // --- State variables ---
    let trainingTime = 0;
    let initialTrainingTime = 0;
    let trainingEndTime = 0;
    let popupIntervalId = null;
    let timerIntervalId = null;
    let logGenerationTimeoutId = null;
    let fakeTimeRemaining = 0;
    let fakeTimerSwitchTime = 0;
    let timeElapsed = 0;
    let isTrainingActive = false;
    let isTrainingFinished = false;
    let logTimeouts = [];
    let intervalCounter = 0;
    let selectedCategories = [];
    let currentFilteredPhrases = [];
    let currentAccentColors = themes[config.ui.defaultTheme].accentColors;
    // Customization State
    let currentConfirmWord = config.defaults.confirmWord;
    let currentPraiseTerm = config.defaults.praiseTerm;

    const cuteSymbols = ['<3', ':3', '^_^', '(^-^*)', '(⌒‿⌒)', '(ﾉ´ヮ´)ﾉ*:･ﾟ✧', '~', '*', '+', '♡', '☆', '✧', '✶', '^^', '>:)', 'o.o', 'xoxo'];


    // --- Helper Functions ---
    // (formatTime, updateTimerDisplay, smoothScrollToBottom, getRandomElement, randomCuteSymbol, getRandomPosition remain the same)
    function formatTime(seconds) { const nonNegativeSeconds = Math.max(0, seconds); const minutes = Math.floor(nonNegativeSeconds / 60); const secs = Math.floor(nonNegativeSeconds % 60); return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; }
    function updateTimerDisplay() { if (!timer) return; timer.textContent = formatTime(trainingTime); timer.style.visibility = trainingTime > 0 ? 'visible' : 'hidden'; }
    function smoothScrollToBottom(element) { if(element) { element.scrollTo({ top: element.scrollHeight, behavior: 'smooth' }); } }
    function getRandomElement(arr) { if (!arr || arr.length === 0) { console.warn("Attempted to get random element from empty or invalid array."); return typeof arr === 'string' ? "..." : '#ffffff'; } return arr[Math.floor(Math.random() * arr.length)]; }
    function randomCuteSymbol() { return getRandomElement(cuteSymbols); }
    function getRandomPosition() { const margin = 20; const popupWidth = 300; const popupHeight = 50; const safeWidth = window.innerWidth - popupWidth - 2 * margin; const safeHeight = window.innerHeight - popupHeight - 2 * margin - 60; const x = Math.random() * safeWidth + margin; const y = Math.random() * safeHeight + margin + 60; return { x: Math.max(margin, x), y: Math.max(margin + 60, y) }; }
    // --- End Helper Functions ---

    // --- Message/Log Functions ---

    /**
     * Displays a temporary popup message on the screen.
     * Simplified styling - relies on CSS variables.
     * @param {string|string[]} message - The message text or array of lines.
     * @param {number} [duration=POPUP_DURATION] - How long the popup stays visible (ms).
     * @param {Function|null} [callback=null] - Function to call after the popup disappears.
     */
    function showPopup(message, duration = config.popups.duration, callback = null) {
        const isFloodMessage = message.toString().toLowerCase().includes(currentPraiseTerm.toLowerCase());
        if (!mainPanel || (!isTrainingActive && !isFloodMessage)) return;
        const popup = document.createElement('div');
        popup.classList.add('popup'); // Relies on CSS variables for styling
        let prefix = "";
        if ((selectedCategories.includes("Cute") || isFloodMessage) && Math.random() < 0.3) { prefix = randomCuteSymbol() + " "; }
        let suffix = "";
        if (Math.random() < 0.2) { suffix = " " + randomCuteSymbol(); }
        popup.innerHTML = prefix + (Array.isArray(message) ? message.join('<br>') : message) + suffix;
        const { x, y } = getRandomPosition();
        popup.style.left = `${x}px`;
        popup.style.top = `${y}px`;
        // Removed dynamic color setting - rely on CSS variable --popup-text-color
        popup.style.color = 'var(--popup-text-color)';
        popup.style.textShadow = '0 0 2px rgba(0,0,0,0.3)'; // Keep basic shadow

        // console.log("DEBUG: Appending popup:", popup); // DEBUG
        mainPanel.appendChild(popup);
        setTimeout(() => {
            if (popup && popup.parentNode === mainPanel) { mainPanel.removeChild(popup); }
            if (callback) { callback(); }
        }, duration);
    }

    /**
     * Clears all active timeouts used for the character typing effect.
     */
    function clearLogTimeouts() { logTimeouts.forEach(timeoutId => clearTimeout(timeoutId)); logTimeouts = []; }

    /**
     * Adds a message to a specified log panel with a typing effect.
     * Applies a random accent color from the current theme.
     * @param {HTMLElement} panel - The log panel element (technoLog, centerLog, rightLog).
     * @param {string} message - The text message to type.
     */
    function typeMessageToLog(panel, message) {
        if (!panel || !message || !currentAccentColors || currentAccentColors.length === 0) {
            // console.warn("DEBUG: Skipping typeMessageToLog due to missing panel, message, or accent colors."); // DEBUG
            return;
        }
        const logEntry = document.createElement('div');
        // Apply random accent color from the current theme's list
        const randomColor = getRandomElement(currentAccentColors);
        logEntry.style.color = randomColor;
        logEntry.style.textShadow = `0 0 5px ${randomColor}`;

        // console.log(`DEBUG: Appending log entry to ${panel.id}:`, logEntry); // DEBUG
        panel.appendChild(logEntry);

        // Restore original typing logic
        while (panel.children.length > config.logs.maxLines) {
            panel.removeChild(panel.firstChild);
        }
        let charIndex = 0;
        function typeChar() {
            if (charIndex < message.length) {
                logEntry.textContent += message[charIndex];
                // console.log("DEBUG: Typing char:", message[charIndex]); // DEBUG - Can be noisy
                smoothScrollToBottom(panel);
                charIndex++;
                const typeSpeed = Math.random() * (config.logs.typeSpeedMax - config.logs.typeSpeedMin) + config.logs.typeSpeedMin;
                const timeoutId = setTimeout(typeChar, typeSpeed);
                logTimeouts.push(timeoutId);
            } else {
                smoothScrollToBottom(panel);
            }
        }
        typeChar(); // Start typing
    }
    // --- End Message/Log Functions ---

    // --- Category Selection Logic ---
    /** Populates the phrase list based on the selectedCategories array */
     function populateFilteredPhrases() {
        currentFilteredPhrases = []; // Reset phrase list
        // console.log("DEBUG: Starting populateFilteredPhrases. Initial selectedCategories:", JSON.stringify(selectedCategories)); // DEBUG Log

        selectedCategories.forEach(category => { // Use selectedCategories array
             // console.log(`DEBUG: Processing category: "${category}"`); // DEBUG Log
             if (phraseCategories[category]) { // Check if category exists in phraseCategories object
                 // console.log(`DEBUG: Found category "${category}" in phraseCategories. Phrase count: ${phraseCategories[category].length}`); // DEBUG Log
                 try {
                    currentFilteredPhrases.push(...phraseCategories[category]); // Add phrases using spread syntax
                    // console.log(`DEBUG: After pushing "${category}", currentFilteredPhrases length: ${currentFilteredPhrases.length}`); // DEBUG Log
                 } catch (e) {
                     console.error(`DEBUG: Error pushing phrases for category "${category}":`, e); // Log push errors
                 }
             } else {
                 console.warn(`DEBUG: Category "${category}" not found as a key in phraseCategories object.`); // Log if key lookup fails
             }
        });
        console.log("DEBUG: Finished populateFilteredPhrases. Final length:", currentFilteredPhrases.length); // Final log
     }

    /** Updates selectedCategories array and Start button state */
    function updateSelectedCategories() {
        if (!categorySelectionDiv) return;
        selectedCategories = []; // Reset current selection
        const buttons = categorySelectionDiv.querySelectorAll('.category-button');
        buttons.forEach(button => {
            if (button.classList.contains('selected')) {
                const categoryRaw = button.dataset.category;
                const category = categoryRaw ? categoryRaw.trim() : null; // Trim whitespace
                // Use the trimmed category name for lookup and storing
                if (category && phraseCategories[category]) {
                    selectedCategories.push(category);
                } else if (category) {
                     // console.warn(`DEBUG: Category "${category}" (raw: "${categoryRaw}") selected but not found in phraseCategories.`);
                }
            }
        });
        try { localStorage.setItem(config.storageKeys.categories, JSON.stringify(selectedCategories)); } catch (e) { console.error("Error saving categories to localStorage:", e); }
        if (startBtn) { startBtn.disabled = selectedCategories.length === 0 || trainingTime <= 0; }
        // console.log("DEBUG: Updated categories state. Selected:", selectedCategories); // DEBUG Log
        // REMOVED call to populateFilteredPhrases from here
     }

    function populateCategorySelection() { if (!categorySelectionDiv) return; categorySelectionDiv.innerHTML = ''; let savedCategories = null; try { const savedData = localStorage.getItem(config.storageKeys.categories); if (savedData) { savedCategories = JSON.parse(savedData); if (!Array.isArray(savedCategories)) { savedCategories = null; localStorage.removeItem(config.storageKeys.categories); } else { savedCategories = savedCategories.filter(cat => phraseCategories.hasOwnProperty(cat)); if (savedCategories.length === 0) savedCategories = null; } } } catch (e) { console.error("Error loading saved categories:", e); savedCategories = null; } Object.keys(phraseCategories).forEach(category => { const button = document.createElement('button'); button.classList.add('category-button'); if (savedCategories === null || savedCategories.includes(category)) { button.classList.add('selected'); } button.dataset.category = category; button.textContent = category; button.addEventListener('click', handleCategoryButtonClick); categorySelectionDiv.appendChild(button); }); updateSelectedCategories(); } // Initial call to set button state
    function handleCategoryButtonClick(event) { const button = event.currentTarget; if (button.disabled) return; button.classList.toggle('selected'); updateSelectedCategories(); } // Update state on click
    function selectAllCategories() { if (!categorySelectionDiv) return; const buttons = categorySelectionDiv.querySelectorAll('.category-button'); buttons.forEach(button => button.classList.add('selected')); updateSelectedCategories(); }
    function deselectAllCategories() { if (!categorySelectionDiv) return; const buttons = categorySelectionDiv.querySelectorAll('.category-button'); buttons.forEach(button => button.classList.remove('selected')); updateSelectedCategories(); }
    // --- End Category Selection Logic ---

    // --- Training Control Functions ---
    // (startTraining, updateTrainingState, updateFakeTimer, startPopupGeneration, startLogGeneration, finishTraining, handleConfirmationSubmit, triggerPraiseFlood, resetApplication, disableSetupControls adjusted in previous steps)
    function startTraining() {
        // --- Ensure phrase list is populated based on current state ---
        // console.log("DEBUG: startTraining called. Current selectedCategories:", selectedCategories); // DEBUG Log
        populateFilteredPhrases();
        // ---

        if (trainingTime <= 0) { showPopup("Please add some training time first!", 2000); return; }
        // Check *after* updating phrases
        if (currentFilteredPhrases.length === 0) {
             showPopup("Please select at least one training category!", 2000);
             console.error("DEBUG: Start prevented - currentFilteredPhrases is empty after populateFilteredPhrases call."); // Added error log
             return;
        }
        isTrainingActive = true; isTrainingFinished = false; initialTrainingTime = trainingTime; fakeTimeRemaining = initialTrainingTime; fakeTimerSwitchTime = initialTrainingTime * config.timers.fakeSwitchRatio; timeElapsed = 0; intervalCounter = 0; if (loadingScreen) loadingScreen.style.display = 'none'; if (mainPanel) mainPanel.style.display = 'block'; if (title) title.classList.add('fixed'); if (fakeTimer) { fakeTimer.textContent = formatTime(fakeTimeRemaining); fakeTimer.classList.add('fixed'); fakeTimer.classList.remove('timer-jump'); } if (crtContainer) crtContainer.classList.add('training-active-bg'); disableSetupControls(true); clearLogTimeouts(); if (technoLog) technoLog.innerHTML = ''; if (centerLog) centerLog.innerHTML = ''; if (rightLog) rightLog.innerHTML = ''; timerIntervalId = setInterval(updateTrainingState, config.timers.intervalMs); /*console.log("DEBUG: Starting Log Generation...");*/ startLogGeneration(); /*console.log("DEBUG: Scheduling Popup Generation...");*/ setTimeout(startPopupGeneration, config.popups.startDelay); console.log(`Training started: ${initialTrainingTime}s, Switch time: ${fakeTimerSwitchTime}s`);
    }
    function updateTrainingState() { if (!isTrainingActive) return; trainingTime -= config.timers.intervalMs / 1000; timeElapsed += config.timers.intervalMs / 1000; intervalCounter++; updateFakeTimer(); if (trainingTime <= 0) { finishTraining(); } }
    function updateFakeTimer() { if (!isTrainingActive || !fakeTimer) return; let currentRate = (fakeTimeRemaining <= fakeTimerSwitchTime) ? config.timers.fakePhase2Rate : config.timers.fakePhase1Rate; fakeTimeRemaining -= (config.timers.intervalMs / 1000) * currentRate; let didJump = false; if (intervalCounter % config.timers.fakeJumpCheckInterval === 0 && Math.random() < config.timers.fakeJumpChance) { const jumpAmount = (Math.random() - 0.5) * config.timers.fakeJumpMagnitude; const previousFakeTime = fakeTimeRemaining; fakeTimeRemaining += jumpAmount; const minFloor = fakeTimerSwitchTime * config.timers.fakeMinFloorRatio; if (fakeTimeRemaining < minFloor && jumpAmount < 0) { fakeTimeRemaining = minFloor; } fakeTimeRemaining = Math.min(fakeTimeRemaining, initialTrainingTime); /*console.log(`DEBUG: Timer Jump Triggered! Amount: ${jumpAmount.toFixed(1)}s (from ${previousFakeTime.toFixed(1)}s to ${fakeTimeRemaining.toFixed(1)}s)`);*/ didJump = true; } fakeTimeRemaining = Math.max(0, fakeTimeRemaining); fakeTimer.textContent = formatTime(fakeTimeRemaining); if (didJump) { fakeTimer.classList.add('timer-jump'); setTimeout(() => { if (fakeTimer) fakeTimer.classList.remove('timer-jump'); }, 300); } /*if (intervalCounter % 10 === 0) { console.log(`DEBUG: Fake Timer Update: Remaining=${fakeTimeRemaining.toFixed(1)}, Rate=${currentRate.toFixed(1)}, Real Time Left=${trainingTime.toFixed(1)}`); }*/ }
    function startPopupGeneration() { if (popupIntervalId) clearTimeout(popupIntervalId); function generatePopup() { /*console.log("DEBUG: generatePopup called.");*/ if (!isTrainingActive || currentFilteredPhrases.length === 0) { /*console.log(`DEBUG: generatePopup stopping: isTrainingActive=${isTrainingActive}, phrases=${currentFilteredPhrases.length}`);*/ if (popupIntervalId) clearTimeout(popupIntervalId); popupIntervalId = null; return; } showPopup(getRandomElement(currentFilteredPhrases)); const nextPopupDelay = Math.random() * (config.popups.maxInterval - config.popups.minInterval) + config.popups.minInterval; /*console.log(`DEBUG: Scheduling next popup in ${nextPopupDelay.toFixed(0)}ms`);*/ popupIntervalId = setTimeout(generatePopup, nextPopupDelay); } const initialDelay = Math.random() * (config.popups.maxInterval - config.popups.minInterval) + config.popups.minInterval; popupIntervalId = setTimeout(generatePopup, initialDelay); /*console.log("DEBUG: Popup generation started.");*/ }
    function startLogGeneration() { clearTimeout(logGenerationTimeoutId); function generateLogEntry() { /*console.log("DEBUG: generateLogEntry called.");*/ if (!isTrainingActive || currentFilteredPhrases.length === 0) { /*console.log(`DEBUG: generateLogEntry stopping: isTrainingActive=${isTrainingActive}, phrases=${currentFilteredPhrases.length}`);*/ logGenerationTimeoutId = null; return; } const message = getRandomElement(currentFilteredPhrases); const targetPanelRoll = Math.random(); let targetPanel = (targetPanelRoll < 0.35) ? technoLog : (targetPanelRoll < 0.75) ? centerLog : rightLog; if (targetPanel) { typeMessageToLog(targetPanel, message); } const averageTypeTime = message.length * ((config.logs.typeSpeedMax + config.logs.typeSpeedMin) / 2); const baseDelay = Math.max(50, averageTypeTime * 0.3); const randomAddition = Math.random() * 250; const nextLogDelay = baseDelay + randomAddition; /*console.log(`DEBUG: Scheduling next log entry in ${nextLogDelay.toFixed(0)}ms`);*/ logGenerationTimeoutId = setTimeout(generateLogEntry, nextLogDelay); } logGenerationTimeoutId = setTimeout(generateLogEntry, 200); /*console.log("DEBUG: Log generation started.");*/ }
    function finishTraining() { console.log("Training Finished! Triggering praise flood..."); isTrainingActive = false; isTrainingFinished = true; if (timerIntervalId) clearInterval(timerIntervalId); if (popupIntervalId) clearTimeout(popupIntervalId); clearTimeout(logGenerationTimeoutId); timerIntervalId = null; popupIntervalId = null; logGenerationTimeoutId = null; if (title) title.classList.add('flash'); if (fakeTimer) fakeTimer.textContent = "00:00"; setTimeout(() => { clearLogTimeouts(); }, config.logs.typeSpeedMax * 2); triggerPraiseFlood(); }
    function handleConfirmationSubmit() { if (!confirmationInput || !confirmationPopup) return; const enteredText = confirmationInput.value.trim(); /*console.log(`DEBUG: Checking confirmation: Entered='${enteredText}', Required='${currentConfirmWord}' (case-insensitive)`);*/ if (enteredText.toLowerCase() === currentConfirmWord.toLowerCase()) { confirmationPopup.style.display = 'none'; resetApplication(); } else { showPopup("Incorrect. Try again.", 1500); confirmationInput.value = ''; confirmationInput.focus(); confirmationPopup.classList.add('shake'); setTimeout(() => { if (confirmationPopup) confirmationPopup.classList.remove('shake'); }, 500); } }
    function triggerPraiseFlood() { /*console.log(`DEBUG: Starting praise flood using term: '${currentPraiseTerm}'`);*/ let linesRemaining = config.flood.totalLines; const praiseTemplates = [ `Good ${currentPraiseTerm}.`, `Such a ${currentPraiseTerm} <3`, `Perfectly obedient.`, `${currentPraiseTerm}~`, `So good for me.`, `${currentPraiseTerm} ^_^` ]; let floodIntervalId = null; function floodStep() { if (linesRemaining <= 0) { if(floodIntervalId) clearInterval(floodIntervalId); console.log("DEBUG: Praise flood finished. Showing confirmation popup."); if (confirmationPopup) { confirmationPopup.style.display = 'flex'; if (confirmationInput) confirmationInput.focus(); } return; } const message = getRandomElement(praiseTemplates) + " " + randomCuteSymbol(); const targetRoll = Math.random(); if (Math.random() < 0.3) { showPopup(message, config.popups.duration * 0.8); } let targetPanel = technoLog; if (targetRoll < 0.33) targetPanel = technoLog; else if (targetRoll < 0.66) targetPanel = centerLog; else targetPanel = rightLog; if (targetPanel && currentAccentColors && currentAccentColors.length > 0) { const logEntry = document.createElement('div'); logEntry.textContent = message; const randomColor = getRandomElement(currentAccentColors); logEntry.style.color = randomColor; logEntry.style.fontWeight = 'bold'; logEntry.style.textShadow = `0 0 5px ${randomColor}`; targetPanel.appendChild(logEntry); while (targetPanel.children.length > config.logs.maxLines + 10) { targetPanel.removeChild(targetPanel.firstChild); } smoothScrollToBottom(targetPanel); } linesRemaining--; } const floodDelay = config.flood.rateBase + (Math.random() - 0.5) * config.flood.rateVariation; floodIntervalId = setInterval(floodStep, Math.max(20, floodDelay)); }
    function resetApplication() { /*console.log("DEBUG: Resetting application...");*/ trainingTime = 0; initialTrainingTime = 0; trainingEndTime = 0; fakeTimeRemaining = 0; fakeTimerSwitchTime = 0; timeElapsed = 0; isTrainingActive = false; isTrainingFinished = false; intervalCounter = 0; if (timerIntervalId) clearInterval(timerIntervalId); if (popupIntervalId) clearTimeout(popupIntervalId); clearTimeout(logGenerationTimeoutId); clearLogTimeouts(); timerIntervalId = null; popupIntervalId = null; logGenerationTimeoutId = null; if (loadingScreen) loadingScreen.style.display = 'flex'; if (mainPanel) mainPanel.style.display = 'none'; if (title) { title.classList.remove('fixed', 'flash'); title.textContent = "TRAINING ROUTINE";} if (fakeTimer) { fakeTimer.classList.remove('fixed', 'timer-jump'); fakeTimer.textContent = "00:00"; } if (crtContainer) crtContainer.classList.remove('training-active-bg'); if (confirmationPopup) { confirmationPopup.style.display = 'none'; confirmationPopup.classList.remove('shake'); } if (confirmationInput) confirmationInput.value = ''; if (technoLog) technoLog.innerHTML = ''; if (centerLog) centerLog.innerHTML = ''; if (rightLog) rightLog.innerHTML = ''; disableSetupControls(false); updateTimerDisplay(); populateCategorySelection(); /*console.log("DEBUG: Application reset complete.");*/ }
    function disableSetupControls(disable) { const buttonsToDisable = [ min1Btn, min10Btn, hour1Btn, extendBtn, startBtn, selectAllBtn, deselectAllBtn, ...(categorySelectionDiv ? Array.from(categorySelectionDiv.querySelectorAll('.category-button')) : []) ]; buttonsToDisable.forEach(btn => { if (btn) { btn.disabled = disable; } }); if (startBtn && !disable) { startBtn.disabled = selectedCategories.length === 0 || trainingTime <= 0; } }
    // --- End Training Control Functions ---

    // --- Settings Menu and Theme Functions ---

    /**
     * Applies the selected theme by setting CSS variables on the :root element.
     * Updates the `currentAccentColors` array and saves the theme choice.
     * @param {string} themeName - The key of the theme in the `themes` object.
     */
    function applyTheme(themeName) {
        const theme = themes[themeName];
        if (!theme || !theme.vars) { // Check theme and vars exist
            console.warn(`Theme "${themeName}" or its vars not found. Applying default.`);
            applyTheme(config.ui.defaultTheme);
            return;
        }

        // console.log(`DEBUG: Applying theme vars for: ${theme.name}`); // DEBUG
        const root = document.documentElement; // Target :root

        // Set all variables from the theme on :root
        for (const [variable, value] of Object.entries(theme.vars)) {
            try {
                root.style.setProperty(variable, value);
            } catch (e) {
                 console.error(`Error setting CSS variable ${variable}:`, e);
            }
        }
        // console.log(`DEBUG: Finished setting ${Object.keys(theme.vars).length} variables for ${themeName}.`); // DEBUG


        // Check if a key variable was actually set after a brief delay
        // This helps confirm if the setProperty calls are having an effect
        setTimeout(() => {
            try {
                const appliedBg = getComputedStyle(root).getPropertyValue('--bg-primary').trim();
                const expectedBg = theme.vars['--bg-primary'];
                // console.log(`DEBUG: Checked --bg-primary after applyTheme. Expected: ${expectedBg}, Actual: ${appliedBg}`); // DEBUG
                if (!appliedBg || (expectedBg && appliedBg.toLowerCase() !== expectedBg.toLowerCase())) {
                     // Note: This comparison might fail due to color format differences (e.g., hex vs rgb)
                     // Check the console - if 'Actual' matches the color for the theme you clicked (even if format differs), it's likely working.
                     // console.warn("DEBUG: --bg-primary might not have been set correctly or format differs!"); // DEBUG
                }
            } catch (e) {
                 console.error("Error checking computed style:", e);
            }
        }, 0);

        // Update accent colors
        currentAccentColors = theme.accentColors || themes[config.ui.defaultTheme].accentColors;
        // console.log("DEBUG: Updated currentAccentColors:", currentAccentColors); // DEBUG

        // Update button states
        const themeButtons = themeSettingsDiv.querySelectorAll('.theme-button');
        themeButtons.forEach(button => {
            button.classList.toggle('selected', button.dataset.theme === themeName);
        });

        // Save theme choice
        try {
            localStorage.setItem(config.storageKeys.theme, themeName);
        } catch (e) {
            console.error("Error saving theme to localStorage:", e);
        }
    }


    function openSettingsPanel() { if (settingsPanel) { settingsPanel.classList.add('open'); } }
    function closeSettingsPanel() { if (settingsPanel) { settingsPanel.classList.remove('open'); } }
    /**
     * Populates the theme selection buttons within the settings panel.
     * Uses the simplified themes object.
     */
    function populateThemeSelector() {
        if (!themeSettingsDiv) return;

        // Clear previous buttons if any
        const existingButtons = themeSettingsDiv.querySelectorAll('.theme-button');
        existingButtons.forEach(btn => btn.remove());

        // Get theme keys to add buttons in original order
        const themeKeys = Object.keys(themes); // Uses the themes object with vars now

        // Add a button for each defined theme
        themeKeys.forEach(themeKey => {
            const themeData = themes[themeKey];
            const button = document.createElement('button');
            button.classList.add('theme-button');
            button.dataset.theme = themeKey; // Store theme key in data attribute
            button.textContent = themeData.name; // Display theme name
            // Add click listener to apply the theme when clicked
            button.addEventListener('click', function() {
                // console.log(`DEBUG: Theme button clicked: ${this.dataset.theme}`); // DEBUG Log click - Removed for clarity
                applyTheme(this.dataset.theme);
            });
            // Append buttons directly to the container
            themeSettingsDiv.appendChild(button);
        });
    }
    // --- End Settings Menu and Theme Functions ---

    // --- Customization Settings Logic ---

    /**
     * Saves the current confirmation word and praise term to localStorage.
     */
    function saveCustomSettings() {
        try {
            localStorage.setItem(config.storageKeys.confirmWord, currentConfirmWord);
            localStorage.setItem(config.storageKeys.praiseTerm, currentPraiseTerm);
            // console.log("DEBUG: Saved custom settings:", { confirmWord: currentConfirmWord, praiseTerm: currentPraiseTerm }); // DEBUG - Removed for brevity
        } catch (e) {
            console.error("Error saving custom settings to localStorage:", e);
        }
    }

    /**
     * Loads customization settings from localStorage or uses defaults.
     * Updates the input fields in the settings panel.
     */
    function loadCustomSettings() {
        try {
            const savedWord = localStorage.getItem(config.storageKeys.confirmWord);
            const savedTerm = localStorage.getItem(config.storageKeys.praiseTerm);

            // Use saved value if it's a non-empty string, otherwise use default
            currentConfirmWord = (savedWord && typeof savedWord === 'string' && savedWord.trim() !== '') ? savedWord : config.defaults.confirmWord;
            currentPraiseTerm = (savedTerm && typeof savedTerm === 'string' && savedTerm.trim() !== '') ? savedTerm : config.defaults.praiseTerm;


            if (confirmWordInput) {
                confirmWordInput.value = currentConfirmWord;
            }
            if (praiseTermInput) {
                praiseTermInput.value = currentPraiseTerm;
            }
            // console.log("DEBUG: Loaded custom settings:", { confirmWord: currentConfirmWord, praiseTerm: currentPraiseTerm }); // DEBUG
        } catch (e) {
            console.error("Error loading custom settings from localStorage:", e);
            // Use defaults in case of error
            currentConfirmWord = config.defaults.confirmWord;
            currentPraiseTerm = config.defaults.praiseTerm;
            if (confirmWordInput) confirmWordInput.value = currentConfirmWord;
            if (praiseTermInput) praiseTermInput.value = currentPraiseTerm;
        }
    }

    // --- Event Listeners ---
    // Add event listeners to buttons if they exist
    if (min1Btn) min1Btn.addEventListener('click', () => { trainingTime += 60; updateTimerDisplay(); updateSelectedCategories(); }); // Update button state on time change
    if (min10Btn) min10Btn.addEventListener('click', () => { trainingTime += 600; updateTimerDisplay(); updateSelectedCategories(); }); // Update button state on time change
    if (hour1Btn) hour1Btn.addEventListener('click', () => { trainingTime += 3600; updateTimerDisplay(); updateSelectedCategories(); }); // Update button state on time change
    if (extendBtn) extendBtn.addEventListener('click', () => { const extendAmount = Math.floor(Math.random() * (config.timers.extendTimeMax - config.timers.extendTimeMin + 1)) + config.timers.extendTimeMin; trainingTime += extendAmount; updateTimerDisplay(); updateSelectedCategories(); }); // Update button state on time change
    if (startBtn) startBtn.addEventListener('click', startTraining);
    if (selectAllBtn) selectAllBtn.addEventListener('click', selectAllCategories);
    if (deselectAllBtn) deselectAllBtn.addEventListener('click', deselectAllCategories);
    if (confirmationButton) confirmationButton.addEventListener('click', handleConfirmationSubmit);
    // Allow submitting confirmation with Enter key
    if (confirmationInput) confirmationInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && confirmationPopup && confirmationPopup.style.display !== 'none') { handleConfirmationSubmit(); } });

    // Settings Menu Listeners
    if (settingsBtn) settingsBtn.addEventListener('click', openSettingsPanel);
    if (closeSettingsBtn) closeSettingsBtn.addEventListener('click', closeSettingsPanel);

    // Customization Input Listeners (Save on input change)
    if (confirmWordInput) {
        confirmWordInput.addEventListener('input', (e) => {
            const newValue = e.target.value.trim(); // Trim whitespace
            // Update state variable, use default if trimmed value is empty
            currentConfirmWord = newValue !== '' ? newValue : config.defaults.confirmWord;
            // Update input field visually if value was defaulted
            if (newValue === '' && e.target.value !== currentConfirmWord) {
                 e.target.value = currentConfirmWord;
            }
            // console.log("DEBUG: Confirm word input changed:", newValue, " | State set to:", currentConfirmWord); // DEBUG
            saveCustomSettings();
        });
    }
    if (praiseTermInput) {
        praiseTermInput.addEventListener('input', (e) => {
            const newValue = e.target.value.trim(); // Trim whitespace
            // Update state variable, use default if trimmed value is empty
            currentPraiseTerm = newValue !== '' ? newValue : config.defaults.praiseTerm;
             // Update input field visually if value was defaulted
            if (newValue === '' && e.target.value !== currentPraiseTerm) {
                 e.target.value = currentPraiseTerm;
            }
            // console.log("DEBUG: Praise term input changed:", newValue, " | State set to:", currentPraiseTerm); // DEBUG
            saveCustomSettings();
        });
    }

    // --- Initialization ---
    // Runs after the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        // console.log("DEBUG: DOM Loaded. Initializing..."); // DEBUG
        // Final check for essential elements needed for initialization
        if (!categorySelectionDiv || !timer || !startBtn || !themeSettingsDiv || !settingsPanel || !settingsBtn || !confirmWordInput || !praiseTermInput) { // Added checks
            console.error("Initialization failed: Missing essential elements for setup.");
            return;
        }

        // Populate UI elements that require dynamic content
        populateCategorySelection(); // Add category buttons & runs updateSelectedCategories
        populateThemeSelector(); // Add theme buttons to settings panel
        loadCustomSettings(); // Load confirmation word and praise term

        // Load and apply saved theme or default theme
        let savedTheme = config.ui.defaultTheme; // Start with the default
        try {
            const storedTheme = localStorage.getItem(config.storageKeys.theme);
            // Check if a theme is saved and if it exists in our theme definitions
            if (storedTheme && themes[storedTheme]) {
                savedTheme = storedTheme; // Use the saved theme
            }
        } catch (e) {
            console.error("Error loading theme from localStorage:", e);
        }
        applyTheme(savedTheme); // Apply the loaded/default theme

        // Set initial UI state
        updateTimerDisplay(); // Show 00:00 timer (hidden)
        disableSetupControls(false); // Ensure controls are enabled initially
        // Update start button state explicitly after initial load
        updateSelectedCategories();


        // Add listener to close settings panel when clicking outside
        document.addEventListener('click', (event) => {
            // Check if the settings panel exists, is open, the click target is not the panel or inside it,
            // and the click target is not the settings button or inside it.
            // Use closest() to handle clicks on elements inside the button/panel.
            if (settingsPanel && settingsPanel.classList.contains('open') &&
                !event.target.closest('#settings-panel') &&
                !event.target.closest('#settings-btn')) {
                closeSettingsPanel();
            }
        });

        // console.log("DEBUG: Initialization complete."); // DEBUG
    });

</script>
</body>
</html>
